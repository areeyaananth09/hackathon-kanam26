    // Helper function to translate API responses
    const translateAPIResponse = (text: string, targetLang: 'ta' | 'hi'): string => {
        if (targetLang === 'ta') {
            return text
                .replace(/Heavy rain forecast/gi, 'பலத்த மழை எதிர்பார்க்கப்படுகிறது')
                .replace(/Saving water/gi, 'தண்ணீரைச் சேமிக்கிறது')
                .replace(/Moisture/gi, 'ஈரப்பதம்')
                .replace(/is sufficient/gi, 'போதுமானது')
                .replace(/is below dynamic threshold/gi, 'மாறும் வரம்புக்குக் கீழே உள்ளது')
                .replace(/Threshold/gi, 'வரம்பு')
                .replace(/for/gi, 'க்கான')
                .replace(/stage/gi, 'நிலை')
                .replace(/Generic Growth/gi, 'பொது வளர்ச்சி')
                .replace(/Germination/gi, 'முளைப்பு')
                .replace(/Vegetative/gi, 'தாவர வளர்ச்சி')
                .replace(/Flowering/gi, 'பூக்கும் நிலை')
                .replace(/Maturation/gi, 'முதிர்ச்சி');
        } else {
            return text
                .replace(/Heavy rain forecast/gi, 'भारी बारिश का पूर्वानुमान')
                .replace(/Saving water/gi, 'पानी बचा रहे हैं')
                .replace(/Moisture/gi, 'नमी')
                .replace(/is sufficient/gi, 'पर्याप्त है')
                .replace(/is below dynamic threshold/gi, 'गतिशील सीमा से नीचे है')
                .replace(/Threshold/gi, 'सीमा')
                .replace(/for/gi, 'के लिए')
                .replace(/stage/gi, 'चरण')
                .replace(/Generic Growth/gi, 'सामान्य विकास')
                .replace(/Germination/gi, 'अंकुरण')
                .replace(/Vegetative/gi, 'वानस्पतिक विकास')
                .replace(/Flowering/gi, 'फूल आना')
                .replace(/Maturation/gi, 'परिपक्वता');
        }
    };

    const speak = (textOrKey: string) => {
        if (typeof window !== 'undefined') {
            // Try to translate if it's a key, otherwise speak the text
            let textToSpeak = translations[language][textOrKey] || textOrKey;

            // If we're not in English and the text wasn't found in translations,
            // it might be raw English text from API - translate it
            if (language !== 'en' && textToSpeak === textOrKey && !translations[language][textOrKey]) {
                textToSpeak = translateAPIResponse(textToSpeak, language);
            }

            // Set the language code
            let targetLang = 'en-US';
            let googleTTSLang = 'en';

            if (language === 'ta') {
                targetLang = 'ta-IN';
                googleTTSLang = 'ta';
            } else if (language === 'hi') {
                targetLang = 'hi-IN';
                googleTTSLang = 'hi';
            }

            // Try browser's native speech synthesis first
            if ('speechSynthesis' in window) {
                const voices = window.speechSynthesis.getVoices();

                // Find a voice that matches the target language
                const matchingVoice = voices.find(voice =>
                    voice.lang.toLowerCase().includes(targetLang.split('-')[0])
                );

                if (matchingVoice) {
                    // Native voice found - use it!
                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    utterance.lang = targetLang;
                    utterance.voice = matchingVoice;
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(utterance);
                    return;
                }
            }

            // Fallback: Use Google Translate TTS for Tamil/Hindi if native voice not available
            // This works without any API key and is completely free!
            if (language === 'ta' || language === 'hi') {
                try {
                    // Create audio element for Google TTS
                    const audio = new Audio();
                    // Google Translate TTS endpoint (free, no auth required)
                    const encodedText = encodeURIComponent(textToSpeak);
                    audio.src = `https://translate.google.com/translate_tts?ie=UTF-8&tl=${googleTTSLang}&client=tw-ob&q=${encodedText}`;

                    // Play the audio
                    audio.play().catch(err => {
                        console.warn('Google TTS failed, falling back to native speech:', err);
                        // Final fallback: use native speech even if it sounds wrong
                        if ('speechSynthesis' in window) {
                            const utterance = new SpeechSynthesisUtterance(textToSpeak);
                            utterance.lang = targetLang;
                            window.speechSynthesis.cancel();
                            window.speechSynthesis.speak(utterance);
                        }
                    });
                } catch (error) {
                    console.error('Speech synthesis error:', error);
                    // Final fallback
                    if ('speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance(textToSpeak);
                        utterance.lang = targetLang;
                        window.speechSynthesis.cancel();
                        window.speechSynthesis.speak(utterance);
                    }
                }
            } else {
                // For English, use native speech synthesis
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    utterance.lang = targetLang;
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(utterance);
                }
            }
        }
    };
